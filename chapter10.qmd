## 第10章 セグメントとクラスター分析


クラスター分析(cluster analysis)は、観測値をいくつかのグループに分ける手法です。ここでは、階層的クラスター分析と非階層的クラスター分析(K-means法)を学習します。

## 階層的クラスター分析

データの中から類似している観測値を段階的にクラスターとしてまとめて、最終的に1つのクラスターになるまで繰り返す方法です。
類似度は距離で測定され、距離が近いほど類似しているとみなされます。
距離概念として、

- ユークリッド距離(Euclidean distance)
- マンハッタン距離(Manhattan distance)
- マハラノビス距離(Mahalanobis distance)

などがあります。
デンドログラム(dendrogram)という樹形図を使って、クラスターの結合過程を視覚的に表現します。

2023年実施の消費者調査アンケートデータを使って、階層的クラスター分析を実行してみます。
必要なパッケージを読み込みます。

- `tidyverse`: データ操作と可視化
- `readxl`: Excelデータの読み込み
- `cluster`: クラスター分析
- `factoextra`: クラスター分析の可視化
- `ggrepel`: グラフ上のラベル配置
- `useful`: 便利な関数群

そしてデータを読み込みます。
`read_xlsx()`関数の引数として，

- `path`: データファイルのパスとファイル名
- `sheet`: 読み込むシート名
- `na`: 欠損値を表す文字列

```{r setup}
pacman::p_load(tidyverse, readxl, cluster, factoextra, ggrepel, useful)
# コード10-1
df_cons <- read_xlsx(
  path = "data/回答データ【消費者調査2023年度下期調査】.xlsx",
  sheet = "回答データ【共通調査2023年度下期】",
  na = " "
  )
```

読み込んだデータを`str()`で確認します。

```{r skimr}
df_cons |>str()
```

992変数，5364観測値からなるデータを読み込みました。
東京都(`13`)と兵庫県(`28`)の回答者を対象に，ブランド志向性(`q12_4`)と価格志向性(`q13_3`)の2変数を使ってクラスター分析を実行します。

教科書では，カテゴリー変数の数値を文字列に変換するために，`case_when()`関数を使っていますが，
この処理だと変数の型が文字列となり，カテゴリー変数としてRが認識しなくなります。
そこでここでは，`factor()`関数を使って，変数の型を因子型に変換し，ラベルを付与する方法を採用します。

```{r}
# 東京と兵庫の県番号リスト作成
ken_number   <- c(13, 28)
# 因子型のラベル作成
pref_labels  <- c("Tokyo", "Hyogo")
gender_label <- c("Male", "Female")
marital_label <- c("Married", "Not Married")

# 回答者と項目を抽出
df_cons <- df_cons |>
  select(県番号, 性別, 年齢, 結婚有無, q12_4, q13_3) |>
  filter(
    県番号 %in% ken_number, # 東京と兵庫の回答者
    q12_4 != 999,           # 欠損値は999
    q13_3 != 999
  ) |>
  mutate(
    q12_4 = 6 - q12_4, # 尺度を反転
    q13_3 = 6 - q13_3, # 尺度を反転
    Pref       = factor(県番号,  levels  = ken_number, labels = pref_labels),
    Gender     = factor(性別,    levels  = c(1, 2), labels = gender_label),
    MaritalSt. = factor(結婚有無, levels = c(1, 2), labels = marital_label)
  )

```

クラスター分析を実行する関数の引数は数値データのみである必要があるので，`select()`で必要な変数だけを抽出し，オブジェクト`clus_cons`に格納します。

`agnes()`関数を使って階層的クラスター分析を実行します。引数として，

- `clus_cons`: クラスター分析対象データ
- `metric`: 距離尺度
- `method`: クラスター結合方法
- `stand`: 変数の標準化

を指定します。
実行結果を`Hier1`に格納し，`pltree()`関数でデンドログラムを作成します。

```{r code10-3}
clus_cons <- df_cons |> select(q12_4, q13_3)


Hier1 <- agnes(
  clus_cons, # クラスター分析対象データ
  metric = "euclidian", # 距離尺度
  method = "ward", # クラスター結合方法
  stand = TRUE # 変数の標準化
  )

pltree(Hier1) # デンドログラムの作成
```


次に，`hclust()`関数を使って階層的クラスター分析を実行します。
階層別クラスターの分析手順は以下の通りです。


```{r code10-4}
alt_Hier <- clus_cons |>
  dist("euclidian") |> # ユークリッド距離の計算
  hclust("ward.D")  # ウォード法による階層的クラスター分析
```


```{r}
alt_Hier |>
  fviz_dend(
    k = 4,  # クラスター数
    rect = TRUE, # クラスター枠の表示
    rect_border = TRUE # クラスター枠の色表示
  )
```

```{r code10-5}
# コード10-5
fviz_nbclust(
  clus_cons,  # クラスター分析対象データ
  kmeans,  # k-means法
  method = "wss" # クラスター内変動の総和
  )
```


```{r code10-6}
alt_Hier |>
  fviz_dend(
    k = 5, # クラスター数
    rect = TRUE, # クラスター枠の表示
    rect_border = TRUE # クラスター枠の色表示
  )
```


```{r code10-7}

# 乱数の種を設定
set.seed(343)

# k-means法による非階層的クラスター分析
K_shopping <- kmeans(clus_cons, 5)
K_shopping
```

```{r code10-8}
# コード10-8

fviz_cluster(
  K_shopping,  # k-means法の結果
  data = clus_cons, # クラスター分析対象データ
  geom = "point" # プロットの形状
  ) +
  labs( # タイトルと軸ラベル
    title = "k = 5",
    x = "Brand switching(Std. score)",
    y = "Price orientation(Std. score)"
  )
```

```{r code10-9}
# コード10-9
df_cons$cluster_id <- factor(K_shopping$cluster)

knitr::kable(head(df_cons), caption = "結合データ")
```

```{r code10-10}
# コード10-10

clus_summary <- df_cons |>
  group_by(cluster_id) |>
  summarize(
    N = n(),
    Loyalty_m = mean(q12_4),
    Price_m   = mean(q13_3),
    Age_m     = mean(年齢),
    Male_r    = sum(Gender == "Male") / n(),
    Tokyo_r   = (sum(Pref == "Tokyo") / n()) / (1465 / 1973),
    Married_r = sum(MaritalSt. == "Married") / n()
  )
# 表示
knitr::kable(clus_summary, caption = "クラスターサマリー")
```


