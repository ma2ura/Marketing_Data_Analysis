{
  "hash": "8854f710252720ef7699777112743cde",
  "result": {
    "engine": "knitr",
    "markdown": "## 第10章 セグメントとクラスター分析\n\n\nクラスター分析(cluster analysis)は、観測値をいくつかのグループに分ける手法です。ここでは、階層的クラスター分析と非階層的クラスター分析(K-means法)を学習します。\n\n## 階層的クラスター分析\n\nデータの中から類似している観測値を段階的にクラスターとしてまとめて、最終的に1つのクラスターになるまで繰り返す方法です。\n類似度は距離で測定され、距離が近いほど類似しているとみなされます。\n距離概念として、\n\n- ユークリッド距離(Euclidean distance)\n- マンハッタン距離(Manhattan distance)\n- マハラノビス距離(Mahalanobis distance)\n\nなどがあります。\nデンドログラム(dendrogram)という樹形図を使って、クラスターの結合過程を視覚的に表現します。\n\n2023年実施の消費者調査アンケートデータを使って、階層的クラスター分析を実行してみます。\n必要なパッケージを読み込みます。\n\n- `tidyverse`: データ操作と可視化\n- `readxl`: Excelデータの読み込み\n- `cluster`: クラスター分析\n- `factoextra`: クラスター分析の可視化\n- `ggrepel`: グラフ上のラベル配置\n- `useful`: 便利な関数群\n\nそしてデータを読み込みます。\n`read_xlsx()`関数の引数として，\n\n- `path`: データファイルのパスとファイル名\n- `sheet`: 読み込むシート名\n- `na`: 欠損値を表す文字列\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npacman::p_load(tidyverse, readxl, cluster, factoextra, ggrepel, useful)\n# コード10-1\ndf_cons <- read_xlsx(\n  path = \"data/回答データ【消費者調査2023年度下期調査】.xlsx\",\n  sheet = \"回答データ【共通調査2023年度下期】\",\n  na = \" \"\n  )\n```\n:::\n\n\n読み込んだデータを`str()`で確認します。\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndf_cons |>str()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ntibble [5,364 × 992] (S3: tbl_df/tbl/data.frame)\n $ 2023年下期no: num [1:5364] 1 2 3 4 7 8 9 10 11 12 ...\n $ 県番号      : num [1:5364] 13 13 27 14 13 13 14 11 25 14 ...\n $ 地域分類    : num [1:5364] 3 3 6 3 3 3 3 3 6 3 ...\n $ 性別        : num [1:5364] 2 1 1 1 1 1 2 2 1 2 ...\n $ 年齢        : num [1:5364] 38 42 25 26 30 33 52 53 36 26 ...\n $ 年齢階層    : num [1:5364] 3 4 2 2 3 3 5 5 3 2 ...\n $ 性年代      : num [1:5364] 11 4 2 2 3 3 13 13 3 10 ...\n $ 結婚有無    : num [1:5364] 2 2 1 1 1 1 1 2 1 2 ...\n $ q1          : num [1:5364] 2 1 1 1 1 1 2 2 1 2 ...\n $ q2t         : num [1:5364] 38 42 25 26 30 33 52 53 36 26 ...\n $ q3          : num [1:5364] 13 13 27 14 13 13 14 11 25 14 ...\n $ q4          : num [1:5364] 1 1 2 2 2 2 2 1 2 1 ...\n $ q5          : num [1:5364] 8 2 7 3 3 3 3 8 4 4 ...\n $ q6          : num [1:5364] 2 2 3 4 1 1 1 2 1 2 ...\n $ q7_1        : num [1:5364] 1 8 2 10 3 5 6 1 5 5 ...\n $ q7_2        : num [1:5364] 4 9 3 10 NA NA NA 4 NA 8 ...\n $ q8          : num [1:5364] 4 4 2 5 2 2 4 1 4 4 ...\n $ q9          : num [1:5364] 1 4 1 2 2 4 1 5 6 5 ...\n $ q10         : num [1:5364] 4 7 2 7 1 1 3 5 NA 5 ...\n $ q11_1       : num [1:5364] 5 4 1 3 4 2 4 2 3 2 ...\n $ q11_2       : num [1:5364] 4 5 2 3 4 2 3 2 3 2 ...\n $ q11_3       : num [1:5364] 4 5 2 3 3 2 4 2 3 2 ...\n $ q11_4       : num [1:5364] 4 4 3 3 4 2 4 2 3 2 ...\n $ q11_5       : num [1:5364] 4 4 3 4 4 2 4 2 3 2 ...\n $ q11_6       : num [1:5364] 4 4 3 3 3 2 4 2 3 2 ...\n $ q11_7       : num [1:5364] 4 5 2 3 4 1 4 2 3 2 ...\n $ q11_8       : num [1:5364] 4 4 3 3 4 1 3 2 3 2 ...\n $ q11_9       : num [1:5364] 4 4 3 2 4 2 5 2 3 3 ...\n $ q11_10      : num [1:5364] 4 5 4 3 3 2 3 2 3 3 ...\n $ q11_11      : num [1:5364] 4 5 3 3 4 2 4 2 3 2 ...\n $ q11_12      : num [1:5364] 4 4 3 3 3 1 4 2 3 2 ...\n $ q11_13      : num [1:5364] 4 4 2 3 3 1 3 3 3 2 ...\n $ q11_14      : num [1:5364] 4 4 2 3 4 1 4 4 3 2 ...\n $ q11_15      : num [1:5364] 4 4 3 4 4 2 3 4 3 2 ...\n $ q11_16      : num [1:5364] 4 4 3 3 4 2 5 3 3 2 ...\n $ q11_17      : num [1:5364] 4 5 3 3 5 2 4 3 3 2 ...\n $ q11_18      : num [1:5364] 4 4 2 3 4 2 4 3 3 3 ...\n $ q11_19      : num [1:5364] 4 5 2 3 5 2 5 3 3 4 ...\n $ q11_20      : num [1:5364] 4 4 3 3 4 2 4 3 3 2 ...\n $ q11_21      : num [1:5364] 4 4 3 3 5 2 3 3 3 4 ...\n $ q11_22      : num [1:5364] 4 4 3 3 4 2 3 3 3 3 ...\n $ q11_23      : num [1:5364] 4 4 4 3 4 1 5 3 3 2 ...\n $ q11_24      : num [1:5364] 4 5 3 3 5 1 4 3 3 2 ...\n $ q11_25      : num [1:5364] 4 4 3 4 4 1 4 3 3 2 ...\n $ q12_1       : num [1:5364] 2 2 3 4 1 3 3 2 3 2 ...\n $ q12_2       : num [1:5364] 2 1 4 3 2 3 2 5 3 4 ...\n $ q12_3       : num [1:5364] 2 2 3 3 1 4 2 5 3 4 ...\n $ q12_4       : num [1:5364] 2 2 3 3 1 4 2 5 3 4 ...\n $ q12_5       : num [1:5364] 2 1 4 3 2 5 3 5 3 4 ...\n $ q13_1       : num [1:5364] 2 2 3 4 2 4 2 2 2 2 ...\n $ q13_2       : num [1:5364] 2 2 3 3 2 5 2 2 2 3 ...\n $ q13_3       : num [1:5364] 2 1 3 3 2 5 2 3 2 2 ...\n $ q13_4       : num [1:5364] 4 5 3 3 5 1 3 3 1 2 ...\n $ q14_1       : num [1:5364] 4 3 3 3 3 2 2 4 3 2 ...\n $ q14_2       : num [1:5364] 4 4 3 3 3 2 2 4 3 3 ...\n $ q14_3       : num [1:5364] 4 4 3 3 3 1 2 4 3 4 ...\n $ q14_4       : num [1:5364] 4 4 3 3 2 1 4 4 3 3 ...\n $ q14_5       : num [1:5364] 4 4 3 3 3 2 5 4 3 3 ...\n $ q14_6       : num [1:5364] 4 5 2 2 3 2 4 4 4 4 ...\n $ q14_7       : num [1:5364] 4 4 3 3 4 2 2 3 3 3 ...\n $ q14_8       : num [1:5364] 4 5 3 4 3 2 2 3 3 3 ...\n $ q14_9       : num [1:5364] 4 4 3 3 5 2 3 3 3 4 ...\n $ q14_10      : num [1:5364] 4 5 2 3 5 1 4 3 3 4 ...\n $ q14_11      : num [1:5364] 4 5 3 3 4 1 2 3 4 2 ...\n $ q14_12      : num [1:5364] 4 4 3 3 3 1 4 3 3 3 ...\n $ q14_13      : num [1:5364] 4 4 3 3 4 2 4 3 3 4 ...\n $ q14_14      : num [1:5364] 4 4 3 3 3 2 2 3 3 3 ...\n $ q14_15      : num [1:5364] 4 5 3 3 3 2 4 3 4 3 ...\n $ q14_16      : num [1:5364] 4 5 2 3 4 1 2 3 3 3 ...\n $ q14_17      : num [1:5364] 4 5 2 3 4 1 4 4 4 3 ...\n $ q15_1       : num [1:5364] 1 2 3 3 2 4 3 3 3 2 ...\n $ q15_2       : num [1:5364] 2 2 3 3 3 5 2 3 3 4 ...\n $ q15_3       : num [1:5364] 2 2 3 3 2 5 2 3 3 3 ...\n $ q15_4       : num [1:5364] 2 1 3 2 3 5 2 3 3 2 ...\n $ q15_5       : num [1:5364] 2 2 3 3 3 4 3 3 3 2 ...\n $ q15_6       : num [1:5364] 2 2 3 2 2 4 1 3 2 3 ...\n $ q15_7       : num [1:5364] 2 2 5 2 3 4 2 3 3 3 ...\n $ q16_1       : num [1:5364] 2 1 3 4 3 3 3 2 4 2 ...\n $ q16_2       : num [1:5364] 2 2 3 3 3 4 4 3 4 2 ...\n $ q16_3       : num [1:5364] 2 2 3 3 3 4 2 3 3 3 ...\n $ q16_4       : num [1:5364] 2 2 3 3 3 4 3 3 3 3 ...\n $ q17_1.01    : num [1:5364] 0 1 0 0 1 1 0 0 0 1 ...\n $ q17_1.02    : num [1:5364] 0 1 0 0 0 0 0 0 0 0 ...\n $ q17_1.03    : num [1:5364] 0 0 0 0 0 0 0 0 0 1 ...\n $ q17_1.04    : num [1:5364] 0 0 0 0 0 0 0 0 0 0 ...\n $ q17_1.05    : num [1:5364] 0 0 0 0 0 0 0 0 0 0 ...\n $ q17_1.06    : num [1:5364] 0 0 0 0 0 0 0 0 0 0 ...\n $ q17_1.07    : num [1:5364] 0 0 0 0 0 0 0 0 0 0 ...\n $ q17_1.08    : num [1:5364] 0 0 0 0 0 0 0 0 0 0 ...\n $ q17_1.09    : num [1:5364] 0 0 0 0 0 0 0 0 0 0 ...\n $ q17_1.10    : num [1:5364] 0 0 0 0 1 0 0 0 0 0 ...\n $ q17_1.11    : num [1:5364] 0 0 0 0 0 0 0 1 0 0 ...\n $ q17_1.12    : num [1:5364] 0 0 0 0 0 0 0 0 0 0 ...\n $ q17_1.13    : num [1:5364] 0 0 0 0 1 0 0 1 0 0 ...\n $ q17_1.14    : num [1:5364] 0 0 0 0 0 0 0 0 0 0 ...\n $ q17_1.15    : num [1:5364] 0 0 0 0 0 0 0 0 0 0 ...\n $ q17_1.16    : num [1:5364] 0 0 0 0 0 0 0 0 0 0 ...\n $ q17_1.17    : num [1:5364] 0 1 0 0 1 0 0 0 0 0 ...\n $ q17_1.18    : num [1:5364] 0 0 0 0 0 0 0 0 0 0 ...\n  [list output truncated]\n```\n\n\n:::\n:::\n\n\n992変数，5364観測値からなるデータを読み込みました。\n東京都(`13`)と兵庫県(`28`)の回答者を対象に，ブランド志向性(`q12_4`)と価格志向性(`q13_3`)の2変数を使ってクラスター分析を実行します。\n\n教科書では，カテゴリー変数の数値を文字列に変換するために，`case_when()`関数を使っていますが，\nこの処理だと変数の型が文字列となり，カテゴリー変数としてRが認識しなくなります。\nそこでここでは，`factor()`関数を使って，変数の型を因子型に変換し，ラベルを付与する方法を採用します。\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 東京と兵庫の県番号リスト作成\nken_number   <- c(13, 28)\n# 因子型のラベル作成\npref_labels  <- c(\"Tokyo\", \"Hyogo\")\ngender_label <- c(\"Male\", \"Female\")\nmarital_label <- c(\"Married\", \"Not Married\")\n\n# 回答者と項目を抽出\ndf_cons <- df_cons |>\n  select(県番号, 性別, 年齢, 結婚有無, q12_4, q13_3) |>\n  filter(\n    県番号 %in% ken_number, # 東京と兵庫の回答者\n    q12_4 != 999,           # 欠損値は999\n    q13_3 != 999\n  ) |>\n  mutate(\n    q12_4 = 6 - q12_4, # 尺度を反転\n    q13_3 = 6 - q13_3, # 尺度を反転\n    Pref       = factor(県番号,  levels  = ken_number, labels = pref_labels),\n    Gender     = factor(性別,    levels  = c(1, 2), labels = gender_label),\n    MaritalSt. = factor(結婚有無, levels = c(1, 2), labels = marital_label)\n  )\n```\n:::\n\n\nクラスター分析を実行する関数の引数は数値データのみである必要があるので，`select()`で必要な変数だけを抽出し，オブジェクト`clus_cons`に格納します。\n\n`agnes()`関数を使って階層的クラスター分析を実行します。引数として，\n\n- `clus_cons`: クラスター分析対象データ\n- `metric`: 距離尺度\n- `method`: クラスター結合方法\n- `stand`: 変数の標準化\n\nを指定します。\n実行結果を`Hier1`に格納し，`pltree()`関数でデンドログラムを作成します。\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nclus_cons <- df_cons |> select(q12_4, q13_3)\n\n\nHier1 <- agnes(\n  clus_cons, # クラスター分析対象データ\n  metric = \"euclidian\", # 距離尺度\n  method = \"ward\", # クラスター結合方法\n  stand = TRUE # 変数の標準化\n  )\n\npltree(Hier1) # デンドログラムの作成\n```\n\n::: {.cell-output-display}\n![](chapter10_files/figure-html/code10-3-1.png){fig-align='center' width=3150}\n:::\n:::\n\n\n\n次に，`hclust()`関数を使って階層的クラスター分析を実行します。\n階層別クラスターの分析手順は以下の通りです。\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nalt_Hier <- clus_cons |>\n  dist(\"euclidian\") |> # ユークリッド距離の計算\n  hclust(\"ward.D\")  # ウォード法による階層的クラスター分析\n```\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nalt_Hier |>\n  fviz_dend(\n    k = 4,  # クラスター数\n    rect = TRUE, # クラスター枠の表示\n    rect_border = TRUE # クラスター枠の色表示\n  )\n```\n\n::: {.cell-output-display}\n![](chapter10_files/figure-html/unnamed-chunk-2-1.png){fig-align='center' width=3150}\n:::\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# コード10-5\nfviz_nbclust(\n  clus_cons,  # クラスター分析対象データ\n  kmeans,  # k-means法\n  method = \"wss\" # クラスター内変動の総和\n  )\n```\n\n::: {.cell-output-display}\n![](chapter10_files/figure-html/code10-5-1.png){fig-align='center' width=3150}\n:::\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nalt_Hier |>\n  fviz_dend(\n    k = 5, # クラスター数\n    rect = TRUE, # クラスター枠の表示\n    rect_border = TRUE # クラスター枠の色表示\n  )\n```\n\n::: {.cell-output-display}\n![](chapter10_files/figure-html/code10-6-1.png){fig-align='center' width=3150}\n:::\n:::\n\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# 乱数の種を設定\nset.seed(343)\n\n# k-means法による非階層的クラスター分析\nK_shopping <- kmeans(clus_cons, 5)\nK_shopping\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nK-means clustering with 5 clusters of sizes 80, 298, 760, 592, 243\n\nCluster means:\n     q12_4    q13_3\n1 1.000000 3.850000\n2 2.738255 4.218121\n3 3.417105 2.792105\n4 2.552365 1.876689\n5 4.300412 4.222222\n\nClustering vector:\n   [1] 5 5 5 4 3 3 3 4 2 3 3 1 3 3 3 3 4 3 3 4 2 4 5 3 2 4 3 4 5 4 3 3 3 4 3 4 3\n  [38] 4 3 3 4 5 4 3 3 4 3 3 4 2 4 2 2 4 4 2 3 3 3 3 4 3 4 3 2 1 2 1 3 4 3 4 2 4\n  [75] 2 3 5 3 4 4 4 3 4 3 2 4 3 2 3 3 3 3 4 2 3 3 3 4 4 3 3 3 4 3 3 3 4 4 3 1 3\n [112] 3 3 3 4 4 3 4 5 4 4 5 3 3 4 3 4 4 4 3 3 3 4 1 2 4 3 2 3 1 4 3 2 4 3 3 4 4\n [149] 3 2 5 2 4 2 3 3 3 4 3 3 4 3 4 4 3 4 4 3 3 4 4 3 2 4 5 3 2 4 3 4 3 3 3 3 3\n [186] 4 3 3 3 3 3 2 4 3 3 2 4 4 4 3 2 3 3 4 4 1 3 3 2 4 3 5 3 3 3 4 4 5 3 2 1 4\n [223] 5 3 5 3 4 4 5 3 4 5 3 4 3 3 4 4 5 3 3 3 5 4 3 4 2 3 2 4 3 4 3 3 4 5 4 2 3\n [260] 3 3 3 5 2 5 4 3 2 3 5 1 4 2 3 4 3 4 3 4 3 2 1 3 3 3 2 3 4 4 2 3 4 3 4 4 3\n [297] 3 3 2 4 3 5 4 2 2 4 4 4 4 5 3 1 3 4 4 4 3 3 5 4 5 4 4 3 2 2 4 4 5 4 3 4 5\n [334] 3 3 4 4 3 3 3 2 1 4 3 4 3 4 3 5 5 2 3 1 2 1 3 3 3 4 2 3 4 4 2 3 3 2 2 3 3\n [371] 4 3 3 3 3 3 3 5 3 3 4 4 3 4 3 2 4 3 4 5 3 2 4 2 3 3 4 3 3 3 3 4 4 4 1 4 3\n [408] 4 3 2 3 3 3 3 3 4 3 1 2 4 2 5 2 3 2 3 2 4 2 3 2 3 4 3 3 3 3 3 2 3 4 3 3 3\n [445] 3 3 3 5 3 3 3 1 3 3 4 4 3 2 3 5 3 4 1 5 4 4 3 2 3 3 4 3 5 4 3 4 4 3 3 4 5\n [482] 4 3 4 2 3 5 4 4 4 3 4 3 4 3 3 4 5 5 3 3 3 5 3 3 1 5 3 4 3 4 5 3 2 2 5 5 3\n [519] 2 3 3 4 2 4 3 3 3 2 5 2 4 5 5 3 3 5 3 4 2 3 3 3 3 3 3 4 4 1 4 3 3 4 2 5 4\n [556] 3 4 3 3 2 5 4 5 3 3 4 5 4 3 2 2 4 4 3 2 4 2 3 2 3 3 2 3 3 3 4 5 3 4 3 3 4\n [593] 2 4 3 3 4 3 4 3 4 3 3 4 3 2 2 3 3 3 2 4 3 4 2 5 5 3 5 3 3 5 3 4 3 1 3 2 3\n [630] 3 5 1 4 3 5 3 2 3 2 4 5 2 3 1 4 4 3 2 4 3 4 3 4 3 2 4 3 4 4 3 4 3 5 4 3 3\n [667] 3 3 3 5 2 3 2 3 4 4 3 5 3 3 4 1 3 4 1 3 5 3 5 4 5 3 3 4 2 3 3 5 2 3 3 3 4\n [704] 3 3 4 3 3 3 3 3 5 4 1 2 3 2 4 2 2 3 5 3 3 3 5 3 4 3 5 3 2 3 4 4 5 4 3 1 3\n [741] 4 3 5 4 3 1 3 3 4 4 3 5 4 3 4 4 4 2 3 4 3 5 3 3 3 4 4 3 1 3 5 2 4 1 2 3 2\n [778] 3 2 3 4 3 5 5 4 3 4 4 3 2 3 3 3 1 3 3 3 3 2 4 4 3 3 2 3 4 4 3 3 4 3 5 4 3\n [815] 4 3 4 1 4 1 4 3 4 5 2 4 2 3 4 3 2 5 4 3 4 4 3 4 2 5 3 2 2 4 3 4 4 4 4 3 5\n [852] 3 2 4 5 4 4 5 2 2 3 1 3 4 5 5 3 2 3 3 5 2 4 3 3 2 4 2 3 1 3 2 2 2 3 2 5 1\n [889] 4 4 5 5 5 4 2 5 2 3 4 1 4 3 5 5 3 2 4 4 4 3 2 2 4 3 3 4 3 3 3 3 3 2 3 2 3\n [926] 5 5 4 3 4 3 4 4 3 1 2 4 5 4 3 5 1 2 4 5 4 4 5 3 3 4 3 4 4 3 4 2 4 2 4 5 4\n [963] 3 2 4 5 4 2 4 2 3 4 3 4 3 2 4 2 3 2 3 4 2 4 2 3 3 3 2 2 4 1 3 4 1 4 3 4 4\n[1000] 3 5 4 2 5 4 5 2 3 3 3 4 3 4 3 3 4 3 3 4 4 2 3 3 5 3 2 5 3 3 3 3 4 3 4 4 5\n[1037] 2 4 3 4 2 3 2 2 4 3 3 3 4 4 2 5 3 3 3 4 3 3 5 4 4 4 2 3 4 5 1 4 3 1 2 5 4\n[1074] 4 3 4 5 4 4 3 4 3 3 4 4 4 3 3 3 4 2 4 2 4 3 2 4 4 3 3 2 3 5 5 4 3 3 5 3 4\n[1111] 2 2 3 4 5 3 4 5 4 4 3 3 3 3 3 3 4 4 3 3 4 4 3 3 4 3 2 4 5 5 5 5 2 4 3 4 3\n[1148] 4 4 2 5 4 3 2 2 3 2 4 3 3 4 4 5 3 2 2 3 4 4 2 4 5 3 5 1 4 3 2 5 3 4 4 3 3\n[1185] 4 1 5 2 4 5 3 3 4 4 3 4 3 5 5 2 3 2 3 4 4 3 2 4 4 3 2 4 3 3 3 2 5 4 1 3 5\n[1222] 4 4 3 3 3 3 4 4 2 3 4 2 5 5 4 5 4 5 2 5 2 5 4 3 3 4 3 5 3 4 4 3 4 4 4 3 3\n[1259] 2 4 2 3 4 4 4 3 4 2 4 2 4 3 4 3 2 2 4 5 5 4 3 3 3 4 4 2 3 3 4 4 3 3 5 1 4\n[1296] 3 4 3 2 3 4 3 3 4 5 3 3 4 3 4 3 2 4 4 3 3 3 5 3 4 3 5 4 4 3 4 3 5 1 4 3 1\n[1333] 2 4 4 5 3 4 4 3 3 3 4 3 3 5 4 3 1 3 3 5 3 3 3 4 2 3 5 3 2 4 3 4 1 3 4 1 5\n[1370] 3 4 3 3 3 4 3 3 5 4 5 4 3 4 2 4 5 2 4 3 3 5 5 3 2 4 5 4 4 3 3 2 3 2 2 3 3\n[1407] 4 4 5 3 4 2 3 2 3 1 2 1 2 3 2 3 3 3 4 4 1 4 2 5 3 5 2 4 4 3 4 4 4 5 3 2 3\n[1444] 1 5 3 4 3 3 3 2 4 3 4 4 3 4 3 2 4 3 4 2 4 3 3 5 4 3 5 4 2 5 4 4 2 3 2 3 3\n[1481] 3 2 5 5 5 4 4 1 3 4 3 4 3 2 5 3 4 3 3 5 1 4 4 4 3 3 3 3 4 3 4 3 4 2 3 3 3\n[1518] 3 5 4 5 5 3 2 4 3 4 4 3 3 4 3 4 3 3 2 4 4 4 5 2 4 4 1 3 3 3 5 3 3 5 3 3 3\n[1555] 3 5 4 3 2 2 4 3 3 2 3 3 3 3 3 4 4 5 5 4 2 4 3 2 3 4 4 3 1 4 2 1 5 4 2 4 3\n[1592] 3 2 3 3 4 5 3 2 2 4 1 3 2 5 3 3 3 2 4 5 5 5 4 3 5 5 4 2 4 3 5 3 1 4 5 3 2\n[1629] 4 5 5 3 2 3 3 4 1 3 5 2 3 3 2 4 3 2 3 2 3 5 3 2 2 5 3 2 4 4 4 3 4 2 4 2 3\n[1666] 2 4 2 5 5 1 3 4 2 3 5 3 3 5 5 3 4 4 2 2 4 2 4 3 4 4 4 3 3 2 2 2 4 5 2 3 3\n[1703] 5 1 3 4 5 2 3 5 5 3 2 2 4 3 3 5 3 4 4 3 3 5 3 4 4 4 3 3 4 4 5 4 4 3 3 3 3\n[1740] 4 3 3 4 2 2 5 3 4 4 2 3 4 4 2 4 3 3 2 3 2 4 2 4 4 4 4 5 2 2 3 4 3 2 4 2 4\n[1777] 4 4 4 4 3 2 4 4 3 4 4 5 4 5 2 2 2 2 3 5 4 5 2 2 1 4 4 2 4 1 3 5 2 4 5 3 1\n[1814] 3 5 4 2 3 3 3 3 2 4 3 5 3 5 3 4 1 5 5 2 3 4 2 5 4 3 5 4 5 3 4 3 4 5 3 4 4\n[1851] 4 3 3 5 1 2 5 3 3 1 2 4 3 4 3 3 4 4 1 5 3 3 3 4 1 2 3 5 5 2 4 3 2 4 4 2 3\n[1888] 2 4 5 4 3 2 3 5 3 1 3 2 3 1 2 3 2 4 3 3 3 3 4 4 3 4 4 3 4 2 4 2 3 3 5 3 4\n[1925] 5 3 4 3 4 4 5 4 1 4 3 3 3 2 2 5 1 4 4 3 3 3 4 4 4 4 2 4 3 4 1 4 5 2 4 3 5\n[1962] 1 3 3 3 4 5 2 3 3 4 3 3\n\nWithin cluster sum of squares by cluster:\n[1]  54.2000 108.4060 401.9303 622.3750 127.0700\n (between_SS / total_SS =  66.7 %)\n\nAvailable components:\n\n[1] \"cluster\"      \"centers\"      \"totss\"        \"withinss\"     \"tot.withinss\"\n[6] \"betweenss\"    \"size\"         \"iter\"         \"ifault\"      \n```\n\n\n:::\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# コード10-8\n\nfviz_cluster(\n  K_shopping,  # k-means法の結果\n  data = clus_cons, # クラスター分析対象データ\n  geom = \"point\" # プロットの形状\n  ) +\n  labs( # タイトルと軸ラベル\n    title = \"k = 5\",\n    x = \"Brand switching(Std. score)\",\n    y = \"Price orientation(Std. score)\"\n  )\n```\n\n::: {.cell-output-display}\n![](chapter10_files/figure-html/code10-8-1.png){fig-align='center' width=3150}\n:::\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# コード10-9\ndf_cons$cluster_id <- factor(K_shopping$cluster)\n\nknitr::kable(head(df_cons), caption = \"結合データ\")\n```\n\n::: {.cell-output-display}\n\n\nTable: 結合データ\n\n| 県番号| 性別| 年齢| 結婚有無| q12_4| q13_3|Pref  |Gender |MaritalSt.  |cluster_id |\n|------:|----:|----:|--------:|-----:|-----:|:-----|:------|:-----------|:----------|\n|     13|    2|   38|        2|     4|     4|Tokyo |Female |Not Married |5          |\n|     13|    1|   42|        2|     4|     5|Tokyo |Male   |Not Married |5          |\n|     13|    1|   30|        1|     5|     4|Tokyo |Male   |Married     |5          |\n|     13|    1|   33|        1|     2|     1|Tokyo |Male   |Married     |4          |\n|     28|    1|   25|        1|     3|     3|Hyogo |Male   |Married     |3          |\n|     28|    1|   32|        1|     3|     3|Hyogo |Male   |Married     |3          |\n\n\n:::\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# コード10-10\n\nclus_summary <- df_cons |>\n  group_by(cluster_id) |>\n  summarize(\n    N = n(),\n    Loyalty_m = mean(q12_4),\n    Price_m   = mean(q13_3),\n    Age_m     = mean(年齢),\n    Male_r    = sum(Gender == \"Male\") / n(),\n    Tokyo_r   = (sum(Pref == \"Tokyo\") / n()) / (1465 / 1973),\n    Married_r = sum(MaritalSt. == \"Married\") / n()\n  )\n# 表示\nknitr::kable(clus_summary, caption = \"クラスターサマリー\")\n```\n\n::: {.cell-output-display}\n\n\nTable: クラスターサマリー\n\n|cluster_id |   N| Loyalty_m|  Price_m|    Age_m|    Male_r|   Tokyo_r| Married_r|\n|:----------|---:|---------:|--------:|--------:|---------:|---------:|---------:|\n|1          |  80|  1.000000| 3.850000| 42.61250| 0.5125000| 0.8753925| 0.5250000|\n|2          | 298|  2.738255| 4.218121| 38.56040| 0.5134228| 0.9400188| 0.6107383|\n|3          | 760|  3.417105| 2.792105| 41.88816| 0.5065789| 1.0100683| 0.5618421|\n|4          | 592|  2.552365| 1.876689| 43.79730| 0.4645270| 1.0191680| 0.4712838|\n|5          | 243|  4.300412| 4.222222| 34.91770| 0.5102881| 1.0363938| 0.6213992|\n\n\n:::\n:::\n\n\n\n",
    "supporting": [
      "chapter10_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}